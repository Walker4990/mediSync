<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.test.mapper.TestScheduleMapper">
    <!-- 검사 예약 존재 여부 -->
    <select id="findByCodeAndDate" parameterType="map" resultType="com.mediSync.project.test.vo.TestSchedule">
        SELECT * FROM test_schedule
        WHERE test_code = #{testCode} AND test_date = #{testDate} AND test_time LIKE CONCAT(#{testTime}, '%')
    </select>

    <!-- 예약 신규 생성 -->
    <insert id="insertSchedule" parameterType="map">
        INSERT INTO test_schedule (test_code, test_name, test_date, test_time, capacity, reserved, status, created_at, updated_at)
        VALUES (
        #{testCode},
        (SELECT test_name FROM test_fee WHERE test_code = #{testCode}),
        #{testDate},
        #{testTime},
        1,
        0,
        'AVAILABLE',
        NOW(),
        NOW()
        )
    </insert>

    <!-- 예약 슬롯 확보 -->
    <update id="reserveSlot" parameterType="map">
        UPDATE test_schedule
        SET reserved = reserved + 1,
        status = CASE
        WHEN reserved + 1 >= capacity THEN 'FULL'
        ELSE 'AVAILABLE'
        END,
        updated_at = NOW()
        WHERE test_code = #{testCode}
        AND test_date = #{testDate}
        AND test_time = #{testTime}
        AND reserved &lt; capacity
    </update>

    <update id="updateTestSchedule" parameterType="testSchedule">
        UPDATE test_schedule
        SET test_date =#{testDate}, test_time=#{testTime}
        WHERE schedule_id = #{scheduleId}
    </update>

    <!-- 예약 카운트 증가 -->
    <update id="increaseReservedCount" parameterType="long">
        UPDATE test_schedule
        SET reserved = reserved + 1
        WHERE schedule_id = #{scheduleId}
    </update>

    <!-- 예약 카운트 감소 -->
    <update id="decreaseReservedCount" parameterType="long">
        UPDATE test_schedule
        SET reserved = CASE WHEN reserved > 0 THEN reserved - 1 ELSE 0 END
        WHERE schedule_id = #{scheduleId}
    </update>


    <!-- 내일 예약 조회하기 -->
    <select id="findTestReservationBetween" resultType="com.mediSync.project.patient.dto.ReservationDTO">
        select
        r.reservation_date,
        a.name as doctorName,
        p.name,
        p.email
        from
        reservation r
        join admin_account a using(admin_id)
        join patient p using(patient_id)
        join notification_setting ns ON p.patient_id = ns.patient_id
        WHERE r.reservation_date BETWEEN #{start} AND #{end}
        AND r.status NOT IN ('CANCELD', 'DONE')
        AND ns.email_enabled = 1
    </select>




</mapper>
