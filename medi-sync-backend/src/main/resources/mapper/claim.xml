<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.insurance.mapper.ClaimMapper">
    <insert id="insertClaim">
        INSERT INTO claim_request
        (record_id, insurer_code, claim_amount, status, auto_generated, created_at)
        VALUES(#{recordId}, #{insurerCode}, #{claimAmount}, 'SENT', #{autoGenerated}, NOW())
    </insert>

    <update id="updateClaimResponse">
        UPDATE claim_response
        SET paid_amount = #{paidAmount}, result_code = #{resultCode}, message = #{message}
        WHERE claim_id = #{claimId}
    </update>

    <insert id="insertClaimResponse">
        INSERT INTO claim_response (claim_id, paid_amount, result_code, paid_date, message)
        VALUES (#{claimId}, #{paidAmount}, #{resultCode}, NOW(), #{message})
    </insert>


    <insert id="insertClaimLog">
        INSERT INTO claim_log
        (claim_id, status, message, logged_at)
        VALUES(#{claimId}, #{status}, #{message}, NOW())
    </insert>

    <select id="findLastClaimByRecord" resultType="map">
        SELECT cr.claim_id, cr.status, cr.claim_amount
        FROM claim_request cr
        WHERE cr.record_id = #{recordId}
        ORDER BY cr.created_at DESC
        LIMIT 1
    </select>

    <!-- 진료 내역 조회 -->
    <select id="selectTreatmentList" resultType="treatment">
        SELECT DISTINCT
        mr.record_id,
        d.dept_name AS department,
        mr.diagnosis,
        mr.total_cost AS amount,
        DATE(mr.created_at) AS date,
        TIME(mr.created_at) AS time,
        c.status AS status
        FROM medical_record mr
        JOIN admin_account a ON mr.admin_id = a.admin_id
        JOIN department d ON a.dept_id = d.dept_id
        LEFT JOIN claim_request c ON mr.record_id = c.record_id
        WHERE mr.patient_id = #{patientId}
        ORDER BY date DESC
    </select>

    <!-- 청구 이력 -->
    <select id="selectClaimHistoryByPatient" resultType="map">
        SELECT
        cr.claim_id      AS claimId,
        cr.claim_amount  AS claimAmount,
        cr.created_at    AS createdAt,
        cr.status        AS status,
        ir.insurer_name  AS insurerName,
        cr.payout_amount AS payoutAmount
        FROM claim_request cr
        JOIN insurer ir
        ON ir.insurer_code = cr.insurer_code
        WHERE EXISTS (
        SELECT 1
        FROM patient_insurance pi
        WHERE pi.insurer_code = cr.insurer_code
        AND pi.patient_id = #{patientId}
        )
        ORDER BY cr.created_at DESC
    </select>

    <select id="countAll">
        SELECT COUNT(*)
        FROM claim_request cr
        JOIN insurer ir
        ON ir.insurer_code = cr.insurer_code
        WHERE EXISTS (
        SELECT 1
        FROM patient_insurance pi
        WHERE pi.insurer_code = cr.insurer_code
        AND pi.patient_id = #{patientId}
        )
    </select>


    <!-- 보험사 목록 -->
    <select id="selectInsurerList" resultType="insurer">
        SELECT insurer_code, insurer_name, api_endpoint, contact
        FROM insurer
        ORDER BY insurer_name
    </select>

    <!-- 보험금 청구 등록 -->
    <insert id="insertClaimRequest" parameterType="requestDto" useGeneratedKeys="true" keyProperty="claimId">
        INSERT INTO claim_request (record_id, insurer_code, claim_amount, status, auto_generated, created_at)
        VALUES (#{recordId}, #{insurerCode}, #{claimAmount}, 'SENT', 0, NOW());
    </insert>

    <insert id="insertClaimItems" parameterType="map">
        INSERT INTO claim_item (claim_id, item_name, amount)
        VALUES
        <foreach collection="items" item="item" separator=",">
            (#{claimId}, #{item.itemName}, #{item.amount})
        </foreach>
    </insert>

    <select id="findTotalCostByRecordId" resultType="java.math.BigDecimal">
        SELECT total_cost FROM medical_record WHERE record_id = #{recordId}
    </select>

    <select id="findCoverageByInsurerCode" resultType="java.math.BigDecimal">
        SELECT coverage_rate FROM patient_insurance WHERE insurer_code = #{insurerCode} LIMIT 1
    </select>
    <!-- 보험사 MOCK API용 -->
    <select id="findPendingClaims" resultType="ClaimRequest">
        SELECT c.claim_id, c.record_id, c.insurer_code, c.claim_amount, m.patient_id
        FROM claim_request c
        JOIN medical_record m ON c.record_id = m.record_id
        WHERE c.status = 'SENT'
    </select>
    <update id="updateClaimPaid">
        UPDATE claim_request
        SET status = 'PAID',
            payout_amount = #{claimAmount},
            paid_date = NOW(),
            updated_at = NOW()
        WHERE claim_id = #{claimId}
    </update>

    <select id="latestClamStatus" parameterType="long" resultType="string">
        SELECT c.status
        FROM claim_request c
        JOIN medical_record r ON c.record_id = r.record_id
        WHERE r.patient_id = #{patientId}
        ORDER BY c.created_at DESC
        LIMIT 1
    </select>
</mapper>
