<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.test.mapper.TestResultMapper">

    <!-- 검사 결과 등록 -->
    <insert id="insertTestResult" parameterType="testResult">
        INSERT INTO test_result
        (record_id, patient_id, admin_id, test_code, test_name, test_area, test_date, result_value, result_note, status, created_at, updated_at)
        VALUES
        (#{recordId}, #{patientId}, #{adminId}, #{testCode}, #{testName}, #{testArea}, #{testDate}, #{resultValue}, #{resultNote}, #{status}, NOW(), NOW())
    </insert>

    <!-- 검사 결과 수정 -->
    <update id="updateResult" parameterType="testResult">
        UPDATE test_result
        SET
        result_value = #{resultValue},
        result_note = #{resultNote},
        status = 'COMPLETED',
        updated_at = NOW()
        WHERE test_result_id = #{testResultId}
    </update>

    <!-- 검사 결과 조회 (예약 ID 기준) -->
    <select id="findByReservationId" parameterType="long" resultType="testResult">
        SELECT
        tr.test_result_id,
        tr.record_id,
        tr.patient_id,
        p.name AS patientName,
        tr.admin_id,
        a.name AS adminName,
        tr.test_code,
        tr.test_name,
        tr.test_area,
        tr.test_date,
        tr.result_value,
        tr.result_note,
        tr.status,
        tr.created_at,
        tr.updated_at
        FROM test_result tr
        JOIN patient p ON tr.patient_id = p.patient_id
        LEFT JOIN admin_account a ON tr.admin_id = a.admin_id
        WHERE tr.patient_id = (
        SELECT patient_id FROM test_reservation WHERE reservation_id = #{reservationId}
        )
    </select>

    <!-- 환자 검사 결과 조회 -->
    <select id="getResultsByPatients" resultType="testResult">
        SELECT
            test_result_id,
            record_id,
            patient_id,
            admin_id,
            test_code,
            test_name,
            test_area,
            test_date,
            result_value,
            result_note,
            status,
            created_at,
            updated_at
        FROM test_result
        WHERE patient_id = #{patientId}
        ORDER BY test_date DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countAll" resultType="int">
        SELECT
            COUNT(*)
        FROM test_result
        WHERE patient_id = #{patientId}
    </select>
    <select id="getResultDetail" resultType="testResult">
        SELECT *
        FROM test_result
        WHERE test_result_id = #{testResultId}
    </select>

</mapper>
