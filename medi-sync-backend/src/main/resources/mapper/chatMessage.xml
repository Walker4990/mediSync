<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.chat.mapper.ChatMessageMapper">

    <insert id="insertMessage" parameterType="chat">
        INSERT INTO chat_message
        (sender_id, sender_type, receiver_id, receiver_type, content, sent_at, chat_type, read_status)
        VALUES (#{senderId}, #{senderType}, #{receiverId}, #{receiverType}, #{content}, NOW(), #{chatType}, #{readStatus})
    </insert>

    <select id="getMessagesBetween" resultType="chat">
        SELECT *
        FROM chat_message
        WHERE (
        (sender_id = #{senderId} AND receiver_id = #{receiverId})
        OR (sender_id = #{receiverId} AND receiver_id = #{senderId})
        )
        ORDER BY sent_at ASC
    </select>

    <!-- 채팅 안읽은 갯수 -->
    <select id="getUnreadCount" resultType="int">
        SELECT COUNT(*)
        FROM chat_message
        WHERE receiver_id = #{receiverId}
        AND sender_id = #{senderId}
        AND read_status = false
    </select>
    <!-- 채팅 읽음 처리-->
    <update id="markMessagesAsRead">
        UPDATE chat_message
        SET read_status = true
        WHERE receiver_id = #{receiverId}
        AND sender_id = #{senderId}
        AND read_status = false
    </update>

    <select id="findChatPartners" resultType="map">
        SELECT DISTINCT
        sender_id AS userId
        FROM chat_message
        WHERE receiver_id = #{adminId}
        ORDER BY userId
    </select>
</mapper>
