<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mediSync.project.medical.mapper.UserAccountMapper">

    <resultMap id="userAccountMap" type="com.mediSync.project.medical.vo.UserAccount">
        <id property="userId" column="user_id"/>
        <result property="loginId" column="login_id"/>
        <result property="password" column="password"/>
        <result property="name" column="name"/>
        <result property="phone" column="phone"/>
        <result property="role" column="role"/>
        <result property="social" column="social"/>
        <result property="createdAt" column="created_at"/>
        <result property="username" column="username"/>
        <result property="userphone" column="userphone"/>
        <result property="useremail" column="useremail"/>

        <association property="patient" javaType="com.mediSync.project.patient.vo.Patient">
            <id property="patientId" column="patient_id"/>
            <result property="residentNo" column="resident_no"/>
            <result property="address" column="address"/>
            <result property="insurerCode" column="insurer_code"/>
            <result property="consentInsurance" column="consent_insurance"/>
            <result property="status" column="status"/>
            <result property="email" column="email"/>
            <result property="age" column="age"/>
            <result property="gender" column="gender"/>
        </association>
    </resultMap>

    <!-- 계정 등록 -->
    <insert id="insertUser" parameterType="user" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO user_account (
        login_id, password, name, phone, email, role, social, created_at
        ) VALUES (
        #{loginId}, #{password}, #{name}, #{phone}, #{email}, 'USER', #{social}, NOW())
    </insert>

    <!-- 전체 계정 목록 조회 -->
    <select id="selectAllUser" resultType="user">
        SELECT * FROM user_account
    </select>

    <!-- 계정 선택 조회 -->
    <select id="selectUserById" parameterType="Long" resultType="user">
        SELECT * FROM user_account WHERE user_id = #{userId}
    </select>

    <!-- 중복 아이디 체크 -->
    <select id="checkIdExists" parameterType="String" resultType="int">
        SELECT COUNT(*)
        FROM user_account
        WHERE login_id = #{loginId}
    </select>

    <!-- 로그인 -->
    <select id="selectUserByLoginId" parameterType="String" resultMap="userAccountMap">
        SELECT u.user_id, u.login_id, u.password, u.name AS username, u.phone AS userphone, u.role, u.email AS useremail, u.created_at,
        p.patient_id, p.resident_no, p.address, p.insurer_code, p.consent_insurance, p.status, p.email AS email, p.age, p.gender
        FROM user_account u LEFT JOIN patient p on (u.user_id = p.user_id)
        WHERE login_id = #{loginId}
    </select>

    <!-- 계정 정보 수정 -->
    <update id="updateUser" parameterType="Long">
        UPDATE user_account
        SET name = #{name}, phone = #{phone}, email = #{email}
        WHERE user_id = #{userId}
    </update>

    <!-- 계정 삭제 -->
    <delete id="deleteUser" parameterType="Long">
        DELETE FROM user_account
        WHERE user_id = #{userId}
    </delete>

    <!-- 아이디 찾기 (이름 + 연락처) -->
    <select id="selectLoginIdByNameAndPhone" resultType="String">
        SELECT login_id
        FROM user_account
        WHERE name = #{name} AND phone = #{phone}
    </select>

    <!-- 비밀번호 변경 -->
    <select id="selectUserForSendEmail" parameterType="user" resultType="user">
        SELECT *
        FROM user_account
        WHERE login_id = #{loginId} AND name = #{name} AND phone = #{phone}
    </select>
    <update id="updatePasswordByUserInfo" parameterType="user">
        UPDATE user_account
        SET password = #{password}
        WHERE login_id = #{loginId}
    </update>


</mapper>
