<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.patient.mapper.ReservationMapper">

    <!--  선택한 날짜의 예약 정보 가져오기  -->
    <select id="getReservedTimesByDate" resultType="String" parameterType="reservation">
        <![CDATA[
        SELECT TIME(reservation_date)
        FROM reservation
        WHERE reservation_date >= #{reservationDate}
        AND reservation_date < DATE_ADD(#{reservationDate}, INTERVAL 1 DAY)
        AND admin_id = #{adminId}
        ]]>

    </select>
    <!--  예약하기  -->
    <insert id="addReservation" parameterType="reservation">
        insert into reservation(patient_id,admin_id,reservation_date,status,created_at,type)
        values(#{patientId},#{adminId},#{reservationDate}, 'WAIT', now(), #{type})
    </insert>

    <!-- 예약 취소하기 -->
    <delete id="deleteReservation" parameterType="reservation">
        delete from reservation
        where
        reservation_id = #{reservationId}
        AND
        patient_id=#{patientId}
        AND
        admin_id = #{adminId}
        AND
        reservation_date = #{reservationDate}
    </delete>
    
    <!-- 내 예약 조회하기 -->
    <select id="selectReservationByPatientId" parameterType="Integer">
        select * from reservation
        where patient_id = #{patientId}
    </select>

    <!-- 내일 예약 조회하기 -->
    <select id="findReservationBetween" resultType="com.mediSync.project.patient.dto.ReservationDTO">
        select
        r.reservation_date,
        a.name as doctorName,
        p.name,
        p.email
        from
        reservation r
        join admin_account a using(admin_id)
        join patient p using(patient_id)
        join notification_setting ns ON p.patient_id = ns.patient_id
        WHERE r.reservation_date BETWEEN #{start} AND #{end}
        AND r.status NOT IN ('CANCEL', 'DONE')
        AND ns.email_enabled = 1
    </select>


    <!-- 예약 상태 업데이트-->
    <update id="updateStatus" parameterType="long">
        UPDATE reservation
        SET status = CASE
        WHEN status = 'WAIT' THEN 'CONSULT'
        WHEN status = 'CONSULT' THEN 'DONE'
        ELSE status
        END,
        updated_at = NOW()
        WHERE reservation_id = #{reservationId}
        AND status IN ('WAIT', 'CONSULT')
    </update>
</mapper>
