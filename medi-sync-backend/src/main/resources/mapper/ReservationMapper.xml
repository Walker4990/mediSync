<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.mapper.ReservationMapper">

    <!--  선택한 날짜의 예약 정보 가져오기  -->
    <select id="getReservedTimesByDate" resultType="String" parameterType="reservation">
        <![CDATA[
        SELECT TIME(reservation_date)
        FROM reservation
        WHERE reservation_date >= #{reservation_date}
        AND reservation_date < DATE_ADD(#{reservation_date}, INTERVAL 1 DAY)
        AND doctor_id = #{doctor_id}
        ]]>

    </select>
    <!--  예약하기  -->
    <insert id="addReservation" parameterType="reservation">
        insert into reservation(patient_id,doctor_id,reservation_date,status,created_at)
        values(#{patient_id},#{doctor_id},#{reservation_date}, 'WAIT', now())
    </insert>

    <!-- 예약 취소하기 -->
    <delete id="deleteReservation" parameterType="reservation">
        delete from reservation
        where
        reservation_id = #{reservation_id}
        AND
        patient_id=#{patient_id}
        AND
        doctor_id = #{doctor_id}
        AND
        reservation_date = #{reservation_date}
    </delete>
    
    <!-- 내 예약 조회하기 -->
    <select id="selectReservationByPatientId" parameterType="Integer">
        select * from reservation
        where patient_id = #{patient_id}
    </select>

    <!-- 오늘 예약 조회하기 -->
    <select id="findReservationBetween" resultType="reservation">
        select * from reservation
        where reservation_date BETWEEN #{start} AND #{end}
    </select>

    <update id="updateStatus" parameterType="reservation">
        UPDATE reservation
        SET status = CASE
        WHEN status = 'WAIT' THEN 'CONSULT'
        WHEN status = 'CONSULT' THEN 'DONE'
        ELSE status
        END,
        updated_at = NOW()
        WHERE patient_id = #{patientId}
        AND status IN ('WAIT', 'CONSULT')
    </update>
</mapper>
