<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.mapper.MedicalRecordMapper">

    <!--  진료 등록  -->
    <insert id="insertRecord"
            parameterType="com.mediSync.project.vo.MedicalRecord"
            useGeneratedKeys="true"
            keyProperty="recordId">

        INSERT INTO medical_record ( patient_id, doctor_id, diagnosis, total_cost, insurance_amount, patient_pay, status, created_at )
        VALUES ( #{patientId}, #{doctorId}, #{diagnosis}, #{totalCost}, #{insuranceAmount}, #{patientPay}, 'COMPLETED', NOW() )
    </insert>
    <!--  진료기록 전체 조회  -->
    <select id="selectRecordAll" resultType="MedicalRecord">
        SELECT * FROM medical_record
    </select>
    <!--  진료기록 조회 - 담당의 정보, 환자정보, 처방내역 등 환자 선택시 가져오기  -->
    <select id="selectRecordAllByPatientId"
            parameterType="long"
            resultType="MedicalRecord">
        SELECT
        mr.record_id,
        mr.patient_id,
        mr.doctor_id,
        d.doctor_name AS doctorName,
        dept.dept_name AS deptName,
        mr.diagnosis,
        mr.total_cost,
        mr.status,
        mr.created_at,
        COUNT(p.prescription_id) AS prescriptionCount
        FROM medical_record mr
        JOIN doctor d ON mr.doctor_id = d.doctor_id
        JOIN department dept ON d.dept_id = dept.dept_id
        LEFT JOIN prescription p ON mr.record_id = p.record_id
        WHERE mr.patient_id = #{patientId}
        GROUP BY mr.record_id
        ORDER BY mr.created_at DESC
    </select>

    <select id="selectRecordById" parameterType="long" resultType="MedicalRecord">
        SELECT r.*, p.name AS patientName, d.doctor_name AS doctorName, dept.dept_name
        FROM medical_record r
        JOIN patient p ON r.patient_id = p.patient_id
        JOIN doctor d ON r.doctor_id = d.doctor_id
        JOIN department dept ON d.dept_id = dept.dept_id
        WHERE r.record_id = #{recordId}
    </select>
</mapper>
