<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.medical.mapper.MedicalRecordMapper">

    <!-- 진료 등록 -->
    <insert id="insertRecord"
            parameterType="com.mediSync.project.medical.vo.MedicalRecord"
            useGeneratedKeys="true"
            keyProperty="recordId">

        INSERT INTO medical_record (
        patient_id, admin_id, diagnosis, total_cost, insurance_amount, patient_pay, status, created_at, reservation_id
        ) VALUES (
        #{patientId}, #{adminId}, #{diagnosis}, #{totalCost}, #{insuranceAmount}, #{patientPay}, 'COMPLETED', NOW(), #{reservationId}
        )
    </insert>

    <!-- 진료기록 전체 조회 -->
    <select id="selectRecordAll" resultType="com.mediSync.project.medical.vo.MedicalRecord">
        SELECT * FROM medical_record
    </select>

    <!-- 환자별 진료기록 조회 -->
    <select id="selectRecordAllByPatientId"
            parameterType="long"
            resultType="com.mediSync.project.medical.vo.MedicalRecord">
        SELECT
        mr.record_id,
        mr.patient_id,
        mr.admin_id,
        a.name AS doctorName,
        dept.dept_name AS deptName,
        mr.diagnosis,
        mr.total_cost,
        mr.status,
        mr.created_at,
        COUNT(p.prescription_id) AS prescriptionCount
        FROM medical_record mr
        JOIN admin_account a ON mr.admin_id = a.admin_id
        JOIN department dept ON a.dept_id = dept.dept_id
        LEFT JOIN prescription p ON mr.record_id = p.record_id
        WHERE mr.patient_id = #{patientId}
        GROUP BY mr.record_id
        ORDER BY mr.created_at DESC
    </select>

    <!-- 페이징 포함 환자별 진료기록 조회 -->
    <select id="selectRecordAllByPatientIdWithPage"
            resultType="com.mediSync.project.medical.vo.MedicalRecord">
        SELECT
        mr.record_id,
        mr.patient_id,
        mr.admin_id,
        a.name AS doctorName,
        dept.dept_name AS deptName,
        mr.diagnosis,
        mr.total_cost,
        mr.status,
        mr.created_at,
        COUNT(p.prescription_id) AS prescriptionCount
        FROM medical_record mr
        JOIN admin_account a ON mr.admin_id = a.admin_id
        JOIN department dept ON a.dept_id = dept.dept_id
        LEFT JOIN prescription p ON mr.record_id = p.record_id
        WHERE mr.patient_id = #{patientId}
        GROUP BY mr.record_id
        ORDER BY mr.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 진료기록 상세 조회 -->
    <select id="selectRecordDetailByRecordId"
            parameterType="long"
            resultType="com.mediSync.project.medical.vo.MedicalRecord">
        SELECT
        mr.record_id,
        mr.patient_id,
        mr.admin_id,
        a.name AS doctorName,
        dept.dept_name AS deptName,
        mr.diagnosis,
        mr.total_cost,
        mr.status,
        mr.created_at,
        pa.name AS patientName
        FROM medical_record mr
        JOIN admin_account a ON mr.admin_id = a.admin_id
        JOIN department dept ON a.dept_id = dept.dept_id
        JOIN patient pa ON mr.patient_id = pa.patient_id
        LEFT JOIN prescription p ON mr.record_id = p.record_id
        WHERE mr.record_id = #{recordId}
        GROUP BY
        mr.record_id,
        mr.patient_id,
        mr.admin_id,
        a.name,
        dept.dept_name,
        mr.diagnosis,
        mr.total_cost,
        mr.status,
        mr.created_at,
        pa.name
    </select>

    <!-- 처방전 조회 -->
    <select id="selectRecordById"
            parameterType="long"
            resultType="com.mediSync.project.medical.vo.MedicalRecord">
        SELECT
        r.*,
        p.name AS patientName,
        a.name AS doctorName,
        dept.dept_name
        FROM medical_record r
        JOIN patient p ON r.patient_id = p.patient_id
        JOIN admin_account a ON r.admin_id = a.admin_id
        JOIN department dept ON a.dept_id = dept.dept_id
        WHERE r.record_id = #{recordId}
    </select>

    <!-- 진료 예약된 환자 조회 -->
    <select id="selectReservedRecords"
            resultType="com.mediSync.project.medical.vo.MedicalRecord">
        SELECT
        res.reservation_id AS reservationId,
        res.reservation_date AS reservationDate,
        res.status AS reservationStatus,
        p.patient_id AS patientId,
        p.name AS patientName,
        a.admin_id AS adminId,
        a.name AS doctorName
        FROM reservation res
        JOIN patient p ON res.patient_id = p.patient_id
        JOIN admin_account a ON res.admin_id = a.admin_id
        WHERE DATE(res.reservation_date) = #{date}
        AND res.status IN ('WAIT', 'CONSULT')
        ORDER BY res.reservation_date ASC
    </select>
    <!-- 보험관련 진료 조회 -->
    <select id="findById" resultType="map">
        SELECT record_id, patient_id, total_cost, status
        FROM medical_record WHERE record_id = #{recordId}
    </select>

    <update id="updateStatus">
        UPDATE medical_record SET status = #{status} WHERE record_id = #{recordId}
    </update>

    <update id="updateAmounts">
        UPDATE medical_record
        SET insurance_amount = #{insuranceAmount}, patient_pay = #{patientPay}
        WHERE record_id = #{recordId}
    </update>


</mapper>
