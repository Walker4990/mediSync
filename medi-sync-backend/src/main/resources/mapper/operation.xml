<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.operation.mapper.OperationMapper">

    <!-- 수술 등록 -->
    <insert id="insertOperation" parameterType="operation" useGeneratedKeys="true" keyProperty="operationId">
        INSERT INTO operation (
        patient_id, admin_id, record_id, operation_name, anesthesia_type,
        room_id, scheduled_date, scheduled_time, duration, cost, status
        ) VALUES (
        #{patientId}, #{adminId}, #{recordId}, #{operationName}, #{anesthesiaType},
        #{roomId}, #{scheduledDate}, #{scheduledTime}, #{duration}, #{cost}, 'SCHEDULED'
        )
    </insert>

    <!-- 수술 목록 조회 -->
    <select id="selectOperationList" resultType="operation">
        SELECT
        o.*,
        p.name AS patientName,
        a.name AS doctorName,
        r.room_name AS roomName
        FROM operation o
        JOIN patient p ON o.patient_id = p.patient_id
        JOIN admin_account a ON o.admin_id = a.admin_id
        LEFT JOIN operation_room r ON o.room_id = r.room_id
        ORDER BY o.scheduled_date DESC, o.scheduled_time ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 수술방 목록 -->
    <select id="selectOperationRoomList" resultType="operationRoom">
        SELECT * FROM operation_room
    </select>

    <!-- 수술방 불러오기 -->
    <select id="getRoomById" parameterType="long" resultType="operationRoom">
        SELECT room_id, room_name, capacity, created_at
        FROM operation_room
        WHERE room_id = #{roomId}
    </select>

    <!-- 특정 수술 상세 조회 -->
    <select id="getOperationById" parameterType="long" resultType="operation">
        SELECT
        o.operation_id,
        o.patient_id,
        p.name AS patientName,
        o.admin_id,
        o.anesthesia_type AS anesthesiaType,
        a.name AS doctorName,
        o.operation_name AS operationName,
        o.cost,
        o.status,
        o.scheduled_date,
        o.scheduled_time,
        o.room_id,
        o.duration,
        o.result_note AS resultNote,
        orr.room_name AS roomName
        FROM operation o
        LEFT JOIN patient p ON o.patient_id = p.patient_id
        LEFT JOIN admin_account a ON o.admin_id = a.admin_id
        LEFT JOIN operation_room orr ON o.room_id = orr.room_id
        WHERE o.operation_id = #{operationId};
    </select>

    <!-- 중복 예약 확인 -->
    <select id="checkScheduleConflict" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM operation
        WHERE room_id = #{roomId}
        AND scheduled_date = #{scheduledDate}
        AND scheduled_time = #{scheduledTime}
        AND status IN ('SCHEDULED', 'IN_PROGRESS')
    </select>

    <!-- 상태 변경 -->
    <update id="updateOperationStatus" parameterType="map">
        UPDATE operation
        SET status = #{status}, updated_at = NOW()
        WHERE operation_id = #{operationId}
    </update>

    <!-- 수술 결과 업데이트 -->
    <update id="updateResult" parameterType="operation">
        UPDATE operation
        SET result_note = #{resultNote},
        status = 'COMPLETED',
        updated_at = NOW()
        WHERE operation_id = #{operationId}
    </update>

    <!-- 수술 상세 정보 수정 -->
    <update id="updateOperation" parameterType="operation">
        UPDATE operation
        SET operation_name = #{operationName},
        anesthesia_type = #{anesthesiaType},
        result_note = #{resultNote},
        duration = #{duration},
        updated_at = NOW()
        WHERE operation_id = #{operationId}
    </update>

    <!-- 참여 스태프 등록 -->
    <insert id="insertOperationStaff" parameterType="operationStaff">
        INSERT INTO operation_staff (operation_id, admin_id, name, position, created_at)
        VALUES (#{operationId}, #{adminId}, #{name}, #{position}, NOW());
    </insert>

    <!-- 참여 스태프 목록 조회 -->
    <select id="selectOperationStaffList" resultType="operationStaff">
        SELECT
        os.staff_id AS staffId,
        os.operation_id AS operationId,
        a.admin_id AS adminId,
        a.name AS name,
        a.position AS position,
        os.created_at AS createdAt
        FROM operation_staff os
        JOIN admin_account a ON os.admin_id = a.admin_id
        WHERE os.operation_id = #{operationId}
        ORDER BY os.created_at DESC
    </select>

    <!-- 로그 등록 -->
    <insert id="insertOperationLog" parameterType="operationLog">
        INSERT INTO operation_log (operation_id, user_name, action, created_at)
        VALUES (#{operationId}, #{userName}, #{action}, NOW())
    </insert>

    <!-- 로그 조회 -->
    <select id="selectOperationLogs" resultType="operationLog">
        SELECT * FROM operation_log
        WHERE operation_id = #{operationId}
        ORDER BY created_at DESC
    </select>

    <!-- 참여 스태프 조회 -->
    <select id="selectStaffByOperationId" parameterType="long" resultType="operationStaff">
        SELECT
        a.admin_id AS adminId,
        a.name     AS name,
        a.position AS position
        FROM operation_staff os
        JOIN admin_account a ON os.admin_id = a.admin_id
        WHERE os.operation_id = #{operationId}
        ORDER BY a.name;
    </select>

    <!-- 참여 스태프 삭제 -->
    <delete id="deleteOperationStaff" parameterType="map">
        DELETE FROM operation_staff
        WHERE operation_id = #{operationId}
        AND admin_id = #{adminId}
    </delete>

    <!-- 중복 스태프 확인 -->
    <select id="checkDuplicateStaff" resultType="int">
        SELECT COUNT(*)
        FROM operation_staff
        WHERE operation_id = #{operationId}
        AND admin_id = #{adminId}
    </select>

    <!-- 수술 가능한 방 선택 -->
    <select id="selectAvailableRooms" resultType="operationRoom">
        SELECT r.*
        FROM operation_room r
        WHERE r.room_id NOT IN (
        SELECT o.room_id
        FROM operation o
        WHERE o.scheduled_date = #{scheduledDate}
        AND o.scheduled_time = #{scheduledTime}
        AND o.status IN ('SCHEDULED','IN_PROGRESS')
        )
    </select>

    <!-- 상태 자동 변경 -->
    <update id="updateScheduledToProgress">
        <![CDATA[
       UPDATE operation
       SET status = 'IN_PROGRESS', updated_at = NOW()
       WHERE status = 'SCHEDULED'
         AND CONCAT(scheduled_date, ' ', scheduled_time) <= NOW()
         AND CONCAT(scheduled_date, ' ', scheduled_time) >= NOW() - INTERVAL 1 HOUR
       ]]>
    </update>

    <!-- IN_PROGRESS → COMPLETED -->
    <update id="updateProgressToCompleted">
        <![CDATA[
       UPDATE operation
       SET status = 'COMPLETED', updated_at = NOW()
       WHERE status = 'IN_PROGRESS'
         AND CONCAT(scheduled_date, ' ', scheduled_time) < NOW() - INTERVAL 4 HOUR
       ]]>
    </update>

    <select id="selectByDate" resultType="operation" parameterType="java.time.LocalDate">
        SELECT op.*, opr.room_name AS roomName, a.name AS doctorName
        FROM operation op
        JOIN operation_room opr ON op.room_id = opr.room_id
        JOIN admin_account a ON op.admin_id = a.admin_id
        WHERE scheduled_date = #{scheduledDate}
        ORDER BY scheduled_time ASC

    </select>
    <!-- 내일 예약 가져오기 -->
    <select id="findOperationBetween" resultType="com.mediSync.project.patient.dto.ReservationDTO">
        select
        o.operation_name as type,
        CAST(TIMESTAMP(o.scheduled_date, o.scheduled_time) AS DATETIME) AS reservationDate,
        a.name as doctorName,
        p.name as name,
        p.email
        from
        operation o
        join admin_account a using(admin_id)
        join patient p using(patient_id)
        join notification_setting ns ON p.patient_id = ns.patient_id
        WHERE ns.email_enabled = 1
        AND o.status NOT IN ('CANCELED', 'COMPLETED')
        AND TIMESTAMP(o.scheduled_date, o.scheduled_time) BETWEEN #{start} AND #{end};
    </select>

    <update id="canceledOperation" parameterType="long">
        update operation
        set type = "CANCELED"
        WHERE operation_id = #{id}
    </update>

    <select id="getBaseCost" parameterType="string" resultType="int">
        SELECT base_cost AS baseCost FROM operation_cost WHERE operation_name = #{operationName}
    </select>

    <update id="updateOperationCost">
        UPDATE operation
        SET cost = #{cost}
        WHERE operation_id = #{operationId}
    </update>

    <select id="getOperationCostList" resultType="cost">
        SELECT * FROM operation_cost ORDER BY operation_name
    </select>

</mapper>
