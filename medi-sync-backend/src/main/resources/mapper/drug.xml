<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mediSync.project.drug.mapper.DrugMapper">

    <select id="selectAllDrug" resultType="drug">
        SELECT
        d.drug_code,
        d.drug_name,
        d.unit_price,
        COALESCE(d.quantity, 0) AS quantity,
        COALESCE(d.location, '-') AS location,
        d.expiration_date,
        d.supplier AS supplier,
        COALESCE(ins.insurer_code, '-') AS insurer_code,
        COALESCE(ins.insurer_name, '-') AS insurer_name,
        d.created_at
        FROM drug d
        LEFT JOIN insurer ins
        ON d.insurance_code = ins.insurer_code
    </select>

    <!-- 약품등록 -->
    <insert id="insertDrug" parameterType="drug">
        INSERT INTO drug (drug_code, drug_name, unit, unit_price, quantity, expiration_date, insurance_code, supplier, created_at,location,min_stock)
        VALUES (#{drugCode}, #{drugName}, #{unit}, #{unitPrice}, #{quantity}, #{expirationDate}, #{insuranceCode}, #{supplier}, now(),#{location},5)
    </insert>

    <select id="selectDrugByDrugCode" parameterType="string" resultType="drug">
        SELECT * FROM drug WHERE drug_code = #{drugCode}
    </select>
    <!-- 약품 재고 등록 -->
    <insert id="insertInventoryItem" parameterType="drug">
        INSERT INTO inventory_item (
        item_name, unit, quantity, price, supplier,
        expiry_date, location, drug_code, updated_at
        ) VALUES (
        #{drugName}, #{unit}, #{quantity}, #{unitPrice}, #{supplier},
        #{expirationDate}, '약품창고-1', #{drugCode}, NOW()
        )
    </insert>
    <!-- 약품 수정 -->
    <update id="editDrug" parameterType="drug">
        UPDATE drug SET
               drug_name = #{drugName},
               unit=#{unit},
               unit_price=#{unitPrice},
               quantity=#{quantity},
               expiration_date=#{expirationDate},
               insurance_code=#{insuranceCode},
               supplier=#{supplier},
               location = #{location}
        WHERE drug_code=#{drugCode}
    </update>

    <!-- 약 재고 수정 -->
    <update id="updateInventoryItem" parameterType="drug">
        UPDATE inventory_item
        SET
        item_name = #{drugName},
        unit = #{unit},
        quantity = #{quantity},
        price = #{unitPrice},
        supplier = #{supplier},
        expiry_date = #{expirationDate}
        WHERE drug_code = #{drugCode}
    </update>
    <!-- 약 정보 삭제 -->
    <delete id="deleteDrug" parameterType="string">
        DELETE FROM drug WHERE drug_code=#{drugCode}
    </delete>
    <delete id="deleteDrugInventory" parameterType="string">
        DELETE FROM inventory_item WHERE drug_code=#{drugCode}
    </delete>
    <!--  자동완성 검색 (약품명 or 코드) -->
    <select id="searchDrugsByKeyword" parameterType="string" resultType="drug">
        SELECT
        drug_code AS drugCode,
        drug_name AS drugName,
        unit,
        unit_price AS unitPrice,
        location,
        quantity AS quantity,
        supplier,
        expiration_date
        FROM drug
        WHERE (drug_name LIKE CONCAT('%', #{keyword}, '%') OR drug_code LIKE CONCAT('%', #{keyword}, '%'))
        AND unit != '주사'
        ORDER BY drug_name
        LIMIT 20
    </select>


    <!--  자동완성 검색 (약품명 or 코드) -->
    <select id="searchDrugsByKeywordIncludeInjection" parameterType="string" resultType="drug">
        SELECT drug_code AS drugCode,
        drug_name AS drugName,
        unit,
        unit_price AS unitPrice,
        location,
        quantity,
        supplier,
        expiration_date,
        drug_code
        FROM drug
        WHERE (drug_name LIKE CONCAT('%', #{keyword}, '%') OR drug_code LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY drug_name
    </select>


    <!-- 주사검색 -->
    <select id="searchInjectionByKeyword" parameterType="string" resultType="drug">
        SELECT drug_code AS drugCode,
        drug_name AS drugName,
        unit,
        unit_price AS unitPrice,
        quantity
        FROM drug
        WHERE (drug_name LIKE CONCAT('%', #{keyword}, '%') OR drug_code LIKE CONCAT('%', #{keyword}, '%'))
        AND unit = '주사'
        ORDER BY drug_name
        LIMIT 20
    </select>

    <select id="selectPaged" resultType="drug">
        SELECT
        d.drug_code AS drugCode,
        d.drug_name AS drugName,
        d.unit_price AS unitPrice,
        COALESCE(d.quantity, 0) AS quantity,
        COALESCE(d.location, '-') AS location,
        d.expiration_date AS expirationDate,
        d.supplier AS supplier,
        COALESCE(ins.insurer_code, '-') AS insuranceCode,
        COALESCE(ins.insurer_name, '-') AS insurerName,
        d.created_at as createdAt
        FROM drug d
        LEFT JOIN insurer ins
        ON d.insurance_code = ins.insurer_code
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countAll" resultType="int">
        SELECT COUNT(*) FROM drug
    </select>

    <update id="decreaseQuantityByInven" parameterType="map">
        UPDATE drug SET quantity = quantity - #{usedQty}
        WHERE drug_name = #{itemName}
        AND quantity >= #{usedQty}
    </update>

    <select id="getDrugPurchaseOrderByDate" parameterType="String" resultType="drugpurchase">
        SELECT * FROM drug_purchase
        where drug_code = #{drugCode}
        AND quantity > 0
        ORDER BY expiration_date ASC
    </select>

    <update id="updateLotQuantity" parameterType="map">
        update drug_purchase
        set
        quantity = #{remain}
        where purchase_id = #{purchaseId}
    </update>

    <delete id="deleteLot" parameterType="int">
        delete from drug_purchase
        where purchase_id = #{purchaseId}
    </delete>
</mapper>
